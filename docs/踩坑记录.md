# iOS 26 踩坑记录

按条目递增的踩坑日志，记录迁移过程中遇到的 iOS 26 新 API 隐性陷阱。

---

## #1 `.buttonStyle(.glass)` 尺寸不可控

**日期：** 2026-02-27

### 问题现象

使用 `.buttonStyle(.glass)` 创建液态玻璃按钮时，无论如何调整 `.controlSize(.mini/.regular/.large)` 或 label 内部 `.frame()`，最终渲染尺寸始终无法精确控制。顶部操作按钮视觉上偏大或偏小，与设计稿不一致。

### 根因分析

`.buttonStyle(.glass)` 是一个**黑盒按钮样式**——系统在 label 外层自动叠加 chrome（内边距 + 玻璃边框），这层 chrome 渲染在开发者指定的 frame 之外。开发者无法通过任何修饰符干预系统 chrome 的尺寸计算，导致最终按钮尺寸完全由系统决定。

简言之：**玻璃 chrome 在 label frame 之外渲染，frame 约束的是 label 而非整个按钮。**

### 解决方案

放弃 `.buttonStyle(.glass)`，改用 `.glassEffect()` 视图修饰符：

- `.buttonStyle(.plain)` 移除所有系统 chrome，让 label 按原始 frame 尺寸渲染
- `.glassEffect(.regular.interactive(), in: .circle)` 在 frame 边界内精确渲染玻璃效果
- `.interactive()` 变体提供按压高亮反馈，保持交互手感

### 关键代码

```swift
// ❌ 之前：尺寸不可控
Button { } label: {
    Image(systemName: "gearshape")
        .frame(width: 36, height: 36)
}
.buttonStyle(.glass)
.buttonBorderShape(.circle)
.controlSize(.mini)

// ✅ 之后：精确控制尺寸
Button { } label: {
    Image(systemName: "gearshape")
        .frame(width: 36, height: 36)
}
.buttonStyle(.plain)
.glassEffect(.regular.interactive(), in: .circle)
```

### 要点

| 方案 | API | 尺寸控制 |
|------|-----|---------|
| 旧（有坑） | `.buttonStyle(.glass)` | 系统托管 chrome，不可控 |
| 新（推荐） | `.buttonStyle(.plain)` + `.glassEffect(.regular.interactive(), in: .circle)` | 精确按 frame 边界渲染 |

---

## #2 `HStack` 中 `ScrollView` 与兄弟视图平分宽度

**日期：** 2026-02-27

### 问题现象

`HeatmapChart` 热力图中，右侧星期标签列（仅显示"一三五"三个字符）占据了容器近一半宽度，网格区域被严重压缩。

### 根因分析

`HStack` 内同时存在两个弹性尺寸子视图：`ScrollView` 和 `weekdayLabels`（`VStack`）。SwiftUI 的 `HStack` 布局算法在协商空间时，`ScrollView` 并不会主动贪婪占满——它的理想尺寸取决于内容尺寸，而非无穷大。当两个子视图都不声明固定尺寸时，`HStack` 会将剩余空间近似均分，导致标签列获得远超实际需要的宽度。

简言之：**`ScrollView` 在 `HStack` 中不是天然贪婪的，必须显式声明 `.frame(maxWidth: .infinity)` 才能占满剩余空间。**

### 解决方案

双向夹击——让 `ScrollView` 贪婪扩展，同时让标签列收缩到内容尺寸：

1. `ScrollView` 外层加 `.frame(maxWidth: .infinity)` — 声明贪婪占满
2. `weekdayLabels` 加 `.fixedSize(horizontal: true, vertical: false)` — 收缩到文字实际宽度

### 关键代码

```swift
// ❌ 之前：ScrollView 与 weekdayLabels 平分宽度
HStack(alignment: .top, spacing: 0) {
    ScrollViewReader { proxy in
        ScrollView(.horizontal, showsIndicators: false) {
            gridContent
        }
    }
    weekdayLabels
}

// ✅ 之后：ScrollView 贪婪占满，标签列收缩到内容宽度
HStack(alignment: .top, spacing: 0) {
    ScrollViewReader { proxy in
        ScrollView(.horizontal, showsIndicators: false) {
            gridContent
        }
    }
    .frame(maxWidth: .infinity)
    weekdayLabels
        .fixedSize(horizontal: true, vertical: false)
}
```

### 要点

| 场景 | 修饰符 | 效果 |
|------|--------|------|
| 让 `ScrollView` 在 `HStack` 中贪婪占满 | `.frame(maxWidth: .infinity)` | 优先分配剩余空间给 ScrollView |
| 让兄弟视图收缩到内容尺寸 | `.fixedSize(horizontal: true, vertical: false)` | 不参与弹性空间分配，仅占文字实际宽度 |
