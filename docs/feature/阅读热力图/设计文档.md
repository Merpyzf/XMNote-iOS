# 阅读热力图 - 设计文档

## 1. 设计概览
- 组件：`xmnote/UIComponents/Charts/HeatmapChart.swift`
- 领域模型：`xmnote/Domain/Models/HeatmapModels.swift`
- 职责：GitHub 风格阅读热力图，展示用户每日阅读/书摘/打卡活动强度。
- 布局核心：`HStack(ScrollView + 固定星期标签)`，星期标签不随横向滚动移动。

## 2. 公开接口

```swift
struct HeatmapChart: View {
    let days: [Date: HeatmapDay]    // 日期→热力数据映射
    let earliestDate: Date?          // 网格起始基准日期，nil 则前推 defaultWeeks 周
    var scrollToMonth: String?       // 程序化滚动目标锚点，格式 "yyyy-M"
    var onDayTap: ((HeatmapDay) -> Void)?  // 方格点击回调
}
```

静态成员：
- `HeatmapChart.legend`：颜色图例条（少 → 多），可在外部自由组合。

## 3. 布局架构

```
HStack(alignment: .top, spacing: 0)
├── ScrollViewReader
│   └── ScrollView(.horizontal)
│       └── VStack(alignment: .leading)
│           ├── monthLabelsRow        ← 顶部日期标签行（仅月切换显示）
│           └── HStack               ← 网格列
│               └── ForEach(displayedWeekColumns)
│                   └── real/padding weekColumn ← 单列 7 个方格
└── weekdayLabels                    ← 固定星期标签列（一/三/五）
```

关键设计决策：
- 星期标签在 `ScrollView` 外部，与 `ScrollView` 平级排列，天然不随滚动移动。
- `defaultScrollAnchor(.trailing)` 使初始视口对齐到最新日期（右侧）。
- 当真实周列不足可视列数时，右侧补齐空列，确保网格从左到右填充，不出现整体居中。

## 4. 网格计算

- `gridStartDate`：取 `earliestDate`（或今天前推 `defaultWeeks` 周），对齐到所在周的周日（weekday=1）。
- `gridEndDate`：今天所在周的周六。
- `weekColumns`：从 `gridStartDate` 到 `gridEndDate`，每 7 天一列，返回 `[[Date]]` 二维数组。
- `minimumVisibleWeekCount`：按可视宽度计算最小周列数。
- `displayedWeekColumns`：真实周列 + 右侧 padding 周列（补齐到最小可视列数）。
- 每列固定 7 行（周日→周六），保证网格矩形对齐。

## 5. 月份标签

- 显示时机：每列首日（周日）与前一列首日月份不同时显示，否则占位 `Color.clear`。
- 同年切换：显示月份短文案（如 `2月`）。
- 跨年切换：显示 `yyyy-M`（如 `2026-1`）。
- 防截断：标签使用 `.fixedSize()` 确保窄列不压缩文本。
- 行高固定 `monthLabelHeight = 16`。

## 6. 程序化滚动

- 机制：`ScrollViewReader` + `.id()` 标记。
- 仅真实列通过 `monthId(week:previousWeek:)` 计算锚点：月份变化时返回 `"yyyy-M"`，否则返回 `nil`。
- padding 列不参与 `scrollToMonth` 锚点映射。
- 外部设置 `scrollToMonth = "2026-1"` 后，`.onChange(of: scrollToMonth)` 触发 `proxy.scrollTo(target, anchor: .leading)`。
- 动画曲线：`.snappy`。

## 7. 领域模型

### HeatmapDay
```swift
struct HeatmapDay: Identifiable {
    let id: Date           // 日历日期（零时零分零秒）
    let readSeconds: Int   // 阅读秒数
    let noteCount: Int     // 书摘数量
    let checkInCount: Int  // 打卡次数
    let checkInSeconds: Int // 打卡时长（秒）
    var level: HeatmapLevel // 综合等级：取三维度最大值
}
```

### HeatmapLevel
五级枚举，对齐 Android `AppConstant.ReadTimeColorLevel`：

| 枚举值 | 颜色令牌 | 无障碍文案 |
|--------|---------|-----------|
| `.none` | `.heatmapNone` | 无活动 |
| `.veryLess` | `.brandLight` | 少量活动 |
| `.less` | `.brand` | 中等活动 |
| `.more` | `.brandDeep` | 较多活动 |
| `.veryMore` | `.brandDarkest` | 大量活动 |

## 8. 视觉常量（HeatmapConst）

| 常量 | 值 | 说明 |
|------|-----|------|
| `squareSize` | 13pt | 方格边长 |
| `squareSpacing` | 3pt | 方格间距 |
| `squareRadius` | 2.5pt | 方格圆角 |
| `rowCount` | 7 | 每列行数（周日→周六） |
| `defaultWeeks` | 20 | 无 earliestDate 时默认前推周数 |
| `weekdayLabelWidth` | 动态测量 | 星期标签列宽（基于字号 9 的文本最大宽度 + 安全边距） |
| `monthLabelHeight` | 16pt | 月份标签行高 |

## 9. 消费方接入指南

```swift
// 基础用法：传入数据字典与最早日期
HeatmapChart(
    days: viewModel.heatmapDays,       // [Date: HeatmapDay]
    earliestDate: viewModel.earliestDate
)

// 完整用法：含点击回调与程序化滚动
HeatmapChart(
    days: viewModel.heatmapDays,
    earliestDate: viewModel.earliestDate,
    scrollToMonth: viewModel.targetMonth  // "2026-2"
) { day in
    viewModel.selectDay(day)
}

// 图例条独立使用
HeatmapChart.legend
```

数据准备要求：
- `days` 字典的 Key 必须是零时零分零秒的 `Date`（使用 `Calendar.startOfDay(for:)`）。
- `earliestDate` 决定网格左边界；传 `nil` 则默认展示最近 20 周。
- `scrollToMonth` 格式严格为 `"yyyy-M"`（如 `"2026-2"`），与 `monthKey(_:)` 输出一致。
