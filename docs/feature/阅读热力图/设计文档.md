# 阅读热力图 - 设计文档

## 1. 设计概览
- 组件：`xmnote/UIComponents/Charts/HeatmapChart.swift`
- 领域模型：`xmnote/Domain/Models/HeatmapModels.swift`
- 职责：GitHub 风格阅读热力图，展示用户每日阅读/书摘/打卡活动强度。
- 布局核心：`HStack(ScrollView + 固定星期标签)`，星期标签不随横向滚动移动。

## 2. 公开接口

```swift
struct HeatmapChart: View {
    let days: [Date: HeatmapDay]    // 日期→热力数据映射
    let earliestDate: Date?          // 网格起始基准日期，nil 则前推 defaultWeeks 周
    var latestDate: Date?            // 网格结束基准日期，nil 则使用今天
    var statisticsDataType: HeatmapStatisticsDataType // 统计类型（书摘/阅读/全部/打卡）
    var style: HeatmapChartStyle     // 可配置视觉参数（方格尺寸/间距/圆角等）
    var scrollToMonth: String?       // 程序化滚动目标锚点，格式 "yyyy-M"
    var onDayTap: ((HeatmapDay) -> Void)?  // 方格点击回调
}
```

静态成员：
- `HeatmapChart.legend`：颜色图例条（少 → 多），可在外部自由组合。

## 3. 布局架构

```
HStack(alignment: .top, spacing: 8)
├── ScrollViewReader
│   └── ScrollView(.horizontal)
│       └── VStack(alignment: .leading)
│           ├── monthLabelsRow        ← 顶部日期标签行（token 绝对定位 + overflow 防重叠）
│           └── HStack               ← 网格列
│               └── ForEach(displayedWeekColumns)
│                   └── weekColumn（真实日期列） ← 单列 7 个方格
└── weekdayLabels                    ← 固定星期标签列（日/二/四/六）
```

关键设计决策：
- 星期标签在 `ScrollView` 外部，与 `ScrollView` 平级排列，天然不随滚动移动。
- 统一间距系统：`axisGap = 8pt`（顶部日期→方格距离 = 右侧星期→方格距离），`outerInset = 0pt`（外边距由消费方容器控制）。
- `defaultScrollAnchor(.trailing)` 使初始视口对齐到最新日期（右侧）。
- 当真实周列不足可视列数时，向前扩展真实日期周列（无活动数据也有日期），确保默认视口优先显示最新数据且月份交接规则可覆盖“空方格列”。

## 4. 网格计算

- `gridStartDate`：取 `earliestDate`（或今天前推 `defaultWeeks` 周），对齐到所在周的周日（weekday=1）。
- `gridEndDate`：`latestDate`（默认为今天）所在周的周六。
- `weekColumns`：从 `gridStartDate` 到 `gridEndDate`，每 7 天一列，返回 `[[Date]]` 二维数组。
- `minimumVisibleWeekCount`：按可视宽度计算最小周列数。
- `displayedWeekColumns`：在真实周列不足可视列数时，向前扩展 `syntheticWeekCount` 个真实日期周列后统一渲染。
- 每列固定 7 行（周日→周六），保证网格矩形对齐。

## 5. 月份标签

- 显示策略：按列首日期从左到右扫描，采用 Android `HistoryChart` 同步规则：
  - 优先“月份变化”绘制 `M月`；
  - 其次“年份变化”绘制 `yyyy`；
  - 年份状态只在绘制年份标签后更新（与 Android 行为一致）。
- 布局策略：不再把文本塞进单列宽度，也不再通过缩小字体规避重叠；改为生成 `HeaderToken(text, x)` 并在顶部行中绝对定位绘制。
- 防重叠策略：维护 `headerOverflow`，每绘制一个 token 执行：
  - `headerOverflow += textWidth + columnAdvance * 0.2`
  - 每列结束后 `headerOverflow = max(0, headerOverflow - columnAdvance)`
- 轴距一致策略：顶部标签行拆为 `headerTextLineHeight + axisGap`，其中 `axisGap` 与右侧星期列间距共用同一常量。
- 适配空方格：左侧补齐列已改为真实日期列，因此“无活动数据的方格列”也能在月份/年份交接处触发顶部标签。
- 文本尺寸：固定可读字号 `9pt`，不使用 `minimumScaleFactor` 缩放取巧。
- 行高定义：`monthLabelHeight = headerTextLineHeight + axisGap`（当前约 19pt）。

## 5.1 星期列垂直对齐

- 星期列采用与网格同构的垂直结构：`monthLabelHeight` 顶部占位 + 7 行固定高度方格行。
- 顶部占位与行容器间距为 `0`，方格行之间间距为 `squareSpacing`，与网格主体保持一致。
- 文本使用固定行高容器居中，确保“日/二/四/六”与对应方格行中心对齐。

## 6. 程序化滚动

- 机制：`ScrollViewReader` + `.id()` 标记。
- 仅真实列通过 `monthId(week:previousWeek:)` 计算锚点：月份变化时返回 `"yyyy-M"`，否则返回 `nil`。
- 由于补齐列已改为真实日期列，所有列都可参与 `scrollToMonth` 锚点映射。
- 外部设置 `scrollToMonth = "2026-1"` 后，`.onChange(of: scrollToMonth)` 触发 `proxy.scrollTo(target, anchor: .leading)`。
- 动画曲线：`.snappy`。

## 7. 领域模型

### HeatmapDay
```swift
struct HeatmapDay: Identifiable {
    let id: Date           // 日历日期（零时零分零秒）
    let readSeconds: Int   // 阅读秒数
    let noteCount: Int     // 书摘数量
    let checkInCount: Int  // 打卡次数
    let checkInSeconds: Int // 打卡时长（秒）
    let bookStates: Set<HeatmapBookState> // 阅读状态集合
    var level: HeatmapLevel // 综合等级：取三维度最大值
}
```

### HeatmapStatisticsDataType
- `noteCount`（书摘）
- `readingTime`（阅读）
- `all`（全部）
- `checkIn`（打卡）

### HeatmapBookState
- `wantRead` / `reading` / `readDone` / `onHold` / `abandon`
- 分段渲染顺序：`wantRead → reading → readDone → onHold → abandon`（对齐 Android `Mark.getColors`）

### HeatmapLevel
五级枚举，对齐 Android `AppConstant.ReadTimeColorLevel`：

| 枚举值 | 颜色令牌 | 无障碍文案 |
|--------|---------|-----------|
| `.none` | `.heatmapNone` | 无活动 |
| `.veryLess` | `.brandLight` | 少量活动 |
| `.less` | `.brand` | 中等活动 |
| `.more` | `.brandDeep` | 较多活动 |
| `.veryMore` | `.brandDarkest` | 大量活动 |

## 8. 视觉样式（HeatmapChartStyle）

| 参数 | 默认值 | 说明 |
|------|-----|------|
| `squareSize` | 13pt | 方格边长 |
| `squareSpacing` | 3pt | 方格间距 |
| `squareRadius` | 2.5pt | 方格圆角 |
| `axisGap` | 8pt | 轴标签统一间距（顶部日期↔方格、右侧星期↔方格） |
| `outerInset` | 0pt | 热力图四周外边距 |
| `headerFontSize` | 9pt | 顶部月/年标签字号 |

预设样式：
- `.default`：与历史行为一致。
- `.readingCard`：在读卡片推荐样式（`squareSize=16`、`squareSpacing=3`、`squareRadius=3`）。

内部固定常量（不暴露到 style）：
- `rowCount = 7`
- `defaultWeeks = 20`
- `headerExtraSpacingFactor = 0.2`

## 9. 消费方接入指南

```swift
// 基础用法：传入数据字典与最早日期
HeatmapChart(
    days: viewModel.heatmapDays,       // [Date: HeatmapDay]
    earliestDate: viewModel.earliestDate,
    latestDate: viewModel.latestDate,
    statisticsDataType: viewModel.selectedDataType,
    style: .default
)

// 完整用法：含点击回调与程序化滚动
HeatmapChart(
    days: viewModel.heatmapDays,
    earliestDate: viewModel.earliestDate,
    latestDate: viewModel.latestDate,
    statisticsDataType: viewModel.selectedDataType,
    style: .readingCard,
    scrollToMonth: viewModel.targetMonth  // "2026-2"
) { day in
    viewModel.selectDay(day)
}

// 图例条独立使用
HeatmapChart.legend

// 图例条按样式输出
HeatmapChart.legend(style: .readingCard)
```

数据准备要求：
- `days` 字典的 Key 必须是零时零分零秒的 `Date`（使用 `Calendar.startOfDay(for:)`）。
- `earliestDate` 决定网格左边界；传 `nil` 则默认展示最近 20 周。
- `latestDate` 决定网格右边界；传 `nil` 则默认展示到今天。
- `statisticsDataType` 决定分段中的阅读量颜色口径（书摘/阅读/全部/打卡）。
- `style` 控制方格尺寸/间距/圆角等视觉参数；不传时使用 `.default`。
- `scrollToMonth` 格式严格为 `"yyyy-M"`（如 `"2026-2"`），与 `monthKey(_:)` 输出一致。

## 10. 在读页接入设计

### 10.1 页面拼装

- 容器页：`ReadingListPlaceholderView`
- 顶部核心组件：`ReadingHeatmapWidgetView`
- 帮助说明弹层：`HeatmapHelpSheetView`
- 日历路由承接页：`ReadCalendarPlaceholderView`（先打通导航链路）

页面结构：

```swift
ScrollView
└── VStack(spacing: 12)
    ├── ReadingHeatmapWidgetView
    │   └── CardContainer(cornerRadius: 18, showsBorder: false)
    │       ├── HeatmapChart
    │       ├── 沉浸式 info 按钮（右上，24pt 视觉/32pt 热区）
    │       └── 错误提示/重试
    └── EmptyState 卡片（现阶段在读列表占位）
```

### 10.2 状态流

- `ReadingHeatmapWidgetViewModel` 负责：
  - 首次加载 `fetchHeatmapData(year: 0, dataType: currentType)`
  - 统计类型切换后重新加载
  - 前后台切换时“跨天刷新”判断
- `ReadingHeatmapWidgetView` 仅负责渲染状态并转发交互：
  - 方格点击 `onOpenReadCalendar(day.id)`
  - 帮助按钮打开弹层
  - 帮助弹层内直接切换统计类型（`Picker(.segmented)`）

### 10.3 在读页视觉与交互策略（2026-02-27）

- 热力图卡片：
  - 圆角 `18pt`，移除默认描边，降低视觉噪声。
  - 内容留白统一：上下左右均使用 `12pt` 基础内边距。
  - 热力图区域不再使用固定高度，改为由 `HeatmapChart` 内在内容高度自适应，避免底部无意义留白。
  - 在读页通过 `style: .readingCard` 使用更大方格（16pt），提升可读性并贴近 Android 体量感。
- 右上角 info 入口：
  - 使用 `info.circle`，图标字号 `11pt`。
  - 视觉尺寸 `24x24`，点击热区 `32x32`。
  - 不使用液态玻璃与描边，保持低干扰与沉浸感。
- 帮助弹层：
  - 使用系统 sheet 容器（`.medium/.large` detents）。
  - 内容不再额外包裹自定义卡片/描边，避免“双层容器”割裂感。
  - 统计类型切换并入弹层正文，底部保留单主动作“完成”。

### 10.4 路由链路

- `ReadingRoute` 新增：`readCalendar(date: Date?)`
- 触发链路：
  - `HeatmapChart.onDayTap -> ReadingHeatmapWidgetView.onOpenReadCalendar`
  - `ReadingListPlaceholderView -> ReadingContainerView`
  - `ReadingContainerView -> MainTabView.readingPath.append(.readCalendar(date:))`
