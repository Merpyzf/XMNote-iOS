# 阅读热力图 - 需求文档

## 1. 背景
- Android 端《纸间书摘》使用 `HistoryChart` 组件在统计页/在读页展示用户阅读活动热力图（GitHub 风格）。
- iOS 端迁移需 100% 对齐 Android 端的交互行为与视觉表现，使用 SwiftUI 原生方式重新实现。
- Android 参考：`AppConstant.ReadTimeColorLevel`（阈值定义）、`HistoryChart`（周列热力图展示实现）。

## 2. 目标
- 实现 GitHub 风格阅读热力图组件 `HeatmapChart`，对齐 Android `HistoryChart` 的核心功能与交互：
  - 星期标签右侧固定（不随横向滚动移动），并显示 `日/二/四/六`。
  - 顶部日期标签按“月份切换”显示：同年显示 `M月`，跨年显示 `yyyy`，并采用 overflow 防重叠策略。
  - 支持程序化滚动到指定月份（`scrollToMonth` 参数）。
- 提供与 Android 一致的统计能力：按统计类型（书摘/阅读/打卡/全部）与年份（全部/指定年）产出热力图数据。
- 提供与 Android 一致的分段方格语义：书籍阅读状态色 + 阅读量热度色叠加。
- 提供五级颜色等级映射，阈值与 Android `AppConstant` 完全一致。
- 支持无障碍读屏。
- 在 iOS 首页「在读」子页接入热力图小组件，包含帮助入口、统计类型切换入口、方格点击跳转阅读日历路由。

## 3. 范围
- 范围内：
  - `HeatmapChart` 组件本身（布局、滚动、交互、无障碍）。
  - `HeatmapDay` / `HeatmapLevel` / `HeatmapStatisticsDataType` / `HeatmapBookState` 领域模型（数据结构与等级阈值）。
  - `StatisticsRepository` 热力图数据聚合（按统计类型、年份查询）。
  - 颜色图例条 `HeatmapChart.legend`。
  - 在读页热力图小组件容器（帮助弹层、统计类型切换、方格点击路由到阅读日历）。
- 范围外：
  - 消费方页面的业务逻辑（统计页、在读页如何组装数据不在本组件范围内）。
  - 测试页 `HeatmapTestView` 属于调试工具，不纳入功能需求。

## 4. 需求细则

### 4.1 Android 对齐点
- 星期标签固定：星期标签固定在网格右侧，横向滚动时不跟随移动，始终可见。
- 星期标签内容：对齐 Android `HistoryChart`，显示 `日/二/四/六`。
- 顶部日期标签：仅在月份切换列显示标签；同年显示 `M月`，跨年显示 `yyyy`；采用 overflow 策略抑制重叠。
- 程序化滚动：外部传入 `scrollToMonth`（格式 `yyyy-M`），组件通过 `ScrollViewReader` 按月份锚点滚动到对应首列。
- 空格子填充：当真实周列数小于可视宽度可容纳列数时，组件必须补齐真实日期周列（无活动也有日期），禁止整体居中显示。
- 空活动日期点击：无数据但非未来日期的方格也可点击回调（对齐 Android 打开日历日期行为）。
- 分段渲染：方格支持“阅读状态色 + 阅读量色”分段叠加，顺序与 Android 一致（想读→在读→读完→搁置→弃读）。
- 图例档位：对齐 Android，仅展示 4 档活动颜色（不单独展示 `none`）。

### 4.2 颜色等级阈值（对齐 Android AppConstant:596-616）

| 等级 | 阅读时长（秒） | 笔记数量 | 打卡时长（秒） |
|------|--------------|---------|--------------|
| none | 0 | 0 | 0 |
| veryLess | 1–1200 | 1–5 | 1–1200 |
| less | 1201–2400 | 6–10 | 1201–2400 |
| more | 2401–3600 | 11–20 | 2401–3600 |
| veryMore | >3600 | >20 | >3600 |

综合等级取阅读时长、笔记数、打卡时长三者最大值。

### 4.3 无障碍读屏
- 每个方格提供 `accessibilityLabel`：日期 + 阅读分钟数 + 打卡次数 + 等级描述。
- 等级文案：无活动 / 少量活动 / 中等活动 / 较多活动 / 大量活动。

### 4.4 在读页挂载要求
- 在读页顶部展示热力图卡片，右上角提供帮助入口。
- 帮助弹层需包含热力图说明文案、书籍状态图例、笔记&读书时长图例，并提供“完成”操作。
- 帮助弹层内需直接提供统计类型切换（全部/打卡/阅读/书摘），切换后热力图立即刷新。
- 方格点击行为：非未来日期可点击并进入在读路由 `readCalendar(date:)`。

## 5. 验收标准
- 星期标签在横向滚动时始终固定在右侧，不随内容移动。
- 星期标签内容为 `日/二/四/六`，并与方格行垂直居中。
- 顶部日期标签在同一年内仅显示月份；跨年切换列显示 `yyyy`，且无重叠。
- `scrollToMonth` 传入有效月份字符串后，网格平滑滚动到目标月份。
- 仅有单月或少量周数据时，热力图通过补齐真实日期周列消除留白，不出现整体居中。
- 五级颜色与 Android 端阈值一一对应，边界值（如 1200/1201）等级跳变正确。
- 方格分段渲染支持阅读状态色叠加，状态与阅读量分段顺序符合 Android。
- 数据仓储支持按统计类型（书摘/阅读/打卡/全部）与年份（全部/指定年）查询。
- 无数据但非未来日期的方格点击后，能触发回调并携带对应日期。
- 在读页帮助弹层展示完整文案与图例，并支持“内联统计类型切换 + 完成”交互。
- 在读页统计类型切换后热力图即时刷新。
- 在读页方格点击后进入阅读日历路由，并携带选中日期。
- VoiceOver 开启后，方格可读出日期、阅读时长、打卡次数与等级。
- 今日方格有品牌色描边高亮，未来日期方格透明不可点击。
