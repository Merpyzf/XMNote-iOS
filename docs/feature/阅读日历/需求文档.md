# 阅读日历 - 需求文档

## 1. 背景
- Android 端阅读日历已具备“按日展示阅读行为 + 书籍事件条 + 跨周分段”的核心能力。
- iOS 端此前仅有占位页，无法承接在读页热力图点击后的关键转化路径。
- 本期目标是完成 iOS 可用版本，同时在交互层补齐“快速月份切换”，并为后续扩展（日详情、筛选、统计）预留结构。

## 2. 目标
- 在 iOS 端提供可正式使用的阅读日历页面，承接两个入口：
  - 在读页热力图点击日期跳转。
  - 我的页“阅读日历”入口。
- 与 Android 业务意图对齐：
  - 同一书籍自然日连续阅读显示为连续区间。
  - 按周渲染分段，但保持跨周连续语义。
  - 同日可展示多本书，超出上限有溢出提示。
- 交互优化：支持按钮切月与左右滑动切月，减少重度用户跨月查找成本。

## 3. 术语
- 每日书籍集合：某自然日存在阅读行为的书籍集合。
- 连续阅读区间 Run：同一本书按自然日连续形成的区间，不按周截断。
- 显示分段 Segment：Run 按周拆分后的渲染片段，仅用于显示层。
- 行位 Lane：为避免事件条重叠分配的稳定行号。

## 4. 范围
### 4.1 范围内
- 月历网格渲染（周一开头）。
- 当月数据加载、缓存、前后月份切换。
- 每日阅读事件条渲染（含跨周连续标记）。
- 今日/选中态/未来日期禁点。
- 空态、错误态、重试。

### 4.2 范围外
- 日详情抽屉/弹层。
- 书籍事件条点击跳转。
- 用户自定义排序与筛选。
- 设置页迁移。

## 5. 用户故事
- 作为在读用户，我在热力图点击某天后，希望直接看到该月上下文，快速判断连续阅读状态。
- 作为复盘用户，我希望跨周阅读能“看起来连续”，避免被误判成两段。
- 作为重度用户，我希望切换月份足够快，不需要反复点击过多次。

## 6. 详细需求

### 6.1 数据语义
- 统计来源覆盖：`read_time_record`、`note`、`category_content`、`review`、`check_in_record`、`book_read_status_record(read_status_id=3)`。
- 按本地时区自然日聚合。
- 同一日同一本书去重，保留最早事件时间用于排序。
- 读完标记按日汇总为 `readDoneCount`。

### 6.2 事件条规则
- 先构建“每日书籍集合”。
- 再生成“连续阅读区间 Run”（按自然日连续，不按周截断）。
- 再按周进行“显示分段 Split”（仅渲染时切段）。
- 再做“行位分配 Lane Assignment”（稳定行号）。
- 视图层只负责画 segments，不反写 day 原始数据。

### 6.3 交互规则
- 上月/下月按钮：单击切月，边界月份按钮禁用。
- 分页滑动切月：支持左右滑动分页切换月份，保持系统级惯性与回弹。
- 选中日期：
  - 初次进入默认选中传入日期；无传入则选中今天。
  - 切月后保留日号（如 31 日切到小月自动夹紧到月末）。
- 未来日期不可选。

### 6.4 展示规则
- 每日最多展示 4 行事件条（与 Android 当前展示策略对齐）。
- 超出部分显示 `+N`。
- 读完日显示庆祝标识。
- 空月展示引导文案；请求失败显示错误与重试。

## 7. 产品优化建议（PM 视角）

### 7.1 月份切换效率（P1）
- 增加“年月快速跳转器”（年-月二级选择）替代多次左右切换。
- 增加“按住连续切月”与触感反馈，提高跨度导航效率。
- 增加“回到今天”快捷入口，降低迷失成本。

### 7.2 信息可读性（P1）
- 事件条可选显示封面主色作为底色（带对比度保护），强化书籍识别。
- 长书名在事件条中采用首尾保留策略（避免全部省略号）。

### 7.3 复盘能力（P2）
- 日期详情抽屉：展示当日事件时间线与来源构成。
- 按书籍筛选：仅看指定书籍在本月的连续轨迹。

### 7.4 可扩展性（P2）
- 支持切换“Android 对齐模式 / 跨周连续增强模式”用于 A/B 或灰度。
- 预留事件条点击回调与埋点位。

## 8. 验收标准
- 从在读页热力图和我的页都能进入阅读日历。
- 月份切换（按钮 + 手势）稳定可用，边界月份禁用正确。
- 同一本书跨周连续阅读可通过视觉连接标记识别为同一条连续行为。
- 日网格、选中态、今日态、未来态显示正确。
- 当日书籍超 4 本时显示 `+N`。
- 空态/错误态/重试路径完整可用。

## 9. 风险与约束
- 当前使用算法配色（基于 bookId），尚未接入真实封面取色缓存，存在“品牌一致性一般”的风险。
- 月份切换在超大跨度场景下仍依赖连续翻页，需后续补“快速跳转”。
- 仅做月维度数据缓存，跨年大跨度滚动场景需关注内存占用。
