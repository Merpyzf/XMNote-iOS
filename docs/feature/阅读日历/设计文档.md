# 阅读日历 - 详细设计文档（代码层面）

## 1. 文档目标
- 给出 iOS 阅读日历的代码级实现规范，确保实现者无需二次决策即可开发/重构。
- 对齐 Android 业务语义（自然日连续 Run + 按周 Split + Lane 分配），避免 UI 机械照搬。
- 解决核心问题：
  - 事件条误绘制到非当月格子（状态错配）。
  - 月份切换交互不顺滑（从手势阈值切换升级为分页滑动）。

## 2. 代码结构与职责映射

### 2.1 Domain 层
- 文件：
  - `xmnote/Domain/Models/ReadCalendarModels.swift`
- 职责：
  - 定义阅读日历基础模型与渲染模型，不含 UI 与数据访问逻辑。
- 核心类型：
  - `ReadCalendarDayBook`
  - `ReadCalendarDay`
  - `ReadCalendarMonthData`
  - `ReadCalendarEventRun`
  - `ReadCalendarEventSegment`
  - `ReadCalendarWeekLayout`
  - `ReadCalendarRenderMode`

### 2.2 Data 层
- 文件：
  - `xmnote/Data/Repositories/StatisticsRepository.swift`
  - `xmnote/Domain/Repositories/RepositoryProtocols.swift`
- 职责：
  - 提供最早可用日期、指定月份聚合数据。
- 接口契约：
  - `fetchReadCalendarEarliestDate() async throws -> Date?`
  - `fetchReadCalendarMonthData(monthStart: Date) async throws -> ReadCalendarMonthData`

### 2.3 ViewModel 层
- 文件：
  - `xmnote/ViewModels/ReadCalendarViewModel.swift`
  - `xmnote/ViewModels/ReadCalendarEventLayoutEngine.swift`
- 职责：
  - 状态中枢：分页、选中态、错误态、缓存、竞态控制。
  - 算法引擎：`Day -> Run -> Segment -> Lane`。

### 2.4 View 层
- 文件：
  - `xmnote/Views/Reading/ReadCalendarView.swift`
  - `xmnote/UIComponents/Foundation/ReadCalendarPanel.swift`
  - `xmnote/UIComponents/Foundation/ReadCalendarMonthGrid.swift`
- 职责：
  - `ReadCalendarView`：页面壳层（导航注入 + ViewModel 状态映射）。
  - `ReadCalendarPanel`：完整阅读日历公共组件（按钮切月 + 分页滑动 + 状态动画）。
  - `ReadCalendarMonthGrid`：底层周网格渲染组件（日期 cell + 事件条段）。

## 3. 关键设计决策

### 3.1 月数据与月网格强绑定
- 旧问题：`loadMonth()` 内部立即重建 `weeks`，但 `displayedMonthStart` 未更新，导致“新数据 + 旧网格”错配。
- 现设计：按月份维持 `MonthPageState`，`weeks` 必须由 `monthStart + dayMap` 显式计算。
- 结论：彻底消除事件条落到非当月日期格子的根因。

### 3.2 切月交互统一到分页选择状态
- 以 `pagerSelection` 作为唯一切月输入状态。
- 顶部左右按钮不直接改数据，只改 `pagerSelection`。
- 分页滑动、按钮切换共用 `handlePagerSelectionChange(to:using:)` 逻辑。

### 3.3 竞态保护
- 引入 `requestTicketSeed + latestRequestTicketByMonthKey`。
- 只有最新 ticket 的请求结果可以落库到 `pageStates`，旧请求自动丢弃。

## 4. ViewModel 详细设计

### 4.1 状态定义
- 全局状态：
  - `displayedMonthStart: Date`
  - `pagerSelection: Date`
  - `selectedDate: Date`
  - `earliestMonthStart: Date?`
  - `availableMonths: [Date]`
  - `isLoading: Bool`
  - `errorMessage: String?`
- 缓存状态：
  - `monthCache: [String: ReadCalendarMonthData]`
  - `pageStates: [String: MonthPageState]`
  - `monthIndexByKey: [String: Int]`
- 并发状态：
  - `requestTicketSeed: Int`
  - `latestRequestTicketByMonthKey: [String: Int]`

### 4.2 页面状态类型
```swift
enum MonthLoadState { idle, loading, loaded, failed }

struct MonthPageState {
    let monthStart: Date
    let weeks: [WeekRowData]
    let dayMap: [Date: ReadCalendarDay]
    let loadState: MonthLoadState
    let errorMessage: String?
}

enum RootContentState { loading, empty, content }
```

### 4.3 不变量（必须满足）
1. `MonthPageState.weeks` 只能由同 `monthStart` 的 `dayMap` 计算得到。
2. `pagerSelection` 必须属于 `availableMonths`。
3. 当前 UI 读取数据时必须指定 `monthStart`，禁止隐式读取“当前月”共享 dayMap。
4. 旧请求结果不得覆盖同月的新请求结果。

### 4.4 主要方法职责
- `loadIfNeeded(using:)`
  - 首次加载入口，幂等。
- `reload(using:)`
  - 刷新全局月份范围与默认选中月，重置缓存。
- `stepPager(offset:)`
  - 按钮切页入口，仅变更 `pagerSelection`。
- `handlePagerSelectionChange(to:using:)`
  - 统一处理切页后的状态同步、加载、预取。
- `ensureMonthLoaded(for:using:showLoading:forceRefresh:reportError:)`
  - 按月加载核心逻辑，包含 ticket 竞态保护。
- `prefetchAdjacentMonths(around:using:)`
  - 预取前后相邻页，提升滑动体验。
- `buildWeeks(monthStart:dayMap:)`
  - 周网格与事件段合并的纯计算函数。

### 4.5 状态机（简化）
- 首次进入：
  - `idle -> loading -> content|empty|failed`
- 单月分页：
  - `loaded -> loading(partial) -> loaded|failed`
- 错误重试：
  - `failed -> loading -> loaded|failed`

## 5. LayoutEngine 算法设计

### 5.1 输入输出
- 输入：`[Date: ReadCalendarDay]`
- 输出：`[ReadCalendarWeekLayout]`

### 5.2 Pipeline
1. 构建每日书籍集合（按 `bookId` 聚合日期）。
2. 生成 Run（自然日连续，不按周截断）。
3. 按周拆分 Segment（仅渲染拆分）。
4. Lane 分配（连续模式保持跨周 lane 稳定）。
5. 按周输出排序后的 `ReadCalendarWeekLayout`。

### 5.3 排序规则
- Run 排序：
  1. `startDate ASC`
  2. `duration DESC`
  3. `firstEventTime ASC`
  4. `bookId ASC`
- Segment 排序：
  1. `laneIndex ASC`
  2. `segmentStartDate ASC`
  3. `segmentEndDate ASC`
  4. `bookId ASC`

### 5.4 渲染模式
- `.crossWeekContinuous`
  - 同一 Run 跨周后 lane 不变；
  - 打开 `continuesFromPrevWeek/continuesToNextWeek`。
- `.androidCompatible`
  - 周内重排 lane；
  - 关闭跨周连接标记（对齐 Android 当前视觉语义）。

## 6. 视图设计（SwiftUI）

### 6.1 页面结构
1. `ReadCalendarView`：页面容器，负责任务触发和 `pagerSelection` 异步同步。
2. `ReadCalendarPanel`：
  - `monthSwitcher`：左右按钮 + 月份标题。
  - `weekdayHeader`：固定 `一~日`。
  - `contentContainer`：
  - `loading`：`ProgressView`
  - `empty`：空态卡片
  - `content`：`TabView(.page)` 月份分页
  - `inlineError`：仅内容态下显示。
3. `ReadCalendarMonthGrid`：每月周网格与事件条渲染。

### 6.2 月份切换交互
- 按钮：
  - `withAnimation(.snappy)` 调 `stepPager(offset:)`。
- 滑动：
  - 系统 `TabView + .page(indexDisplayMode: .never)` 分页。
- 统一监听：
  - `onChange(of: pagerSelection)` -> `handlePagerSelectionChange(...)`。

### 6.3 周行渲染
- `ReadCalendarMonthGrid` 内部周行负责单周网格与 segment overlay：
  - cell 背景态（选中/今日/默认）。
  - 未来日期降透明且不可点击。
  - overflow `+N` 与读完标识。
  - segment 文本显示阈值控制、连接箭头显示。

### 6.4 视觉系统（纸感 + 轻拟物）
- 背景：二级页面统一 `Color.windowBackground`，不叠加首页顶部渐变阴影。
- 主卡：统一大圆角（`CornerRadius.calendarCard`）+ 克制阴影，形成“浮起但不抢眼”的层级。
- 分周：弱化硬分割线，以周间距和留白作为主分隔手段。
- 事件条：低饱和冷中性色板（雾蓝/灰青/蓝灰紫等），端点按跨周连接状态做渐隐过渡。
- 选中日期：浅底 + 描边 + 字重提升，不再使用高饱和实心块。
- 顶部切月：胶囊步进栏使用轻玻璃质感，仅用于控制层，不进入正文区。
- 分层保护：`weekdayHeader` 与首周网格之间保持固定正间距，禁止首行日期上浮覆盖标题。

## 7. 动画规范（强制）
- 结构切换（loading/empty/content）：
  - `transition(.opacity + .scale(0.98))`
  - `.animation(.smooth, value: rootContentState)`
- 分页切换：
  - 使用系统分页动画 + 外层 `snappy` 驱动按钮切页。
- 月份标题切换：
  - `.contentTransition(.numericText())`
  - `.animation(.snappy, value: monthTitle)`
- 错误条显隐：
  - `.transition(.move(edge: .top) + .opacity)`
  - `.animation(.spring, value: errorMessage)`

## 8. 边界与异常处理
- 月份边界：
  - 最小 `earliestMonthStart`，最大当月 `currentMonthStart`。
- 切月选中策略：
  - 切换月份不自动改写选中日期。
  - 仅当用户点击某一天时才更新选中态（选中态绑定真实选择日期）。
- 空月：
  - 可显示空网格，不视为错误。
- 当前页错误：
  - 展示 `inlineError`，支持单页重试。
- 连续快速滑动：
  - ticket 机制保证最终状态一致。

## 9. 与 Android 对齐策略

### 9.1 严格对齐项
- 自然日连续语义。
- 周切段语义。
- 同日多书排序稳定性。
- 每日显示上限（4）与 `+N` 规则。

### 9.2 iOS 原生表达项
- 切月采用系统分页而非手势阈值。
- 结构变化必须动画，不做硬切。

## 10. 测试与验收

### 10.1 单元测试建议
- `ReadCalendarEventLayoutEngine`：
  - Run 合并正确性（跨周、断点、同日去重）。
  - Segment 切分与连接标记正确性。
  - Lane 稳定性。
- `ReadCalendarViewModel`：
  - `monthStart/dayMap/weeks` 一致性。
  - 越界月份保护。
  - 快速切页竞态保护。
  - 选中日夹紧。

### 10.2 手工验收用例
1. 当月查看时不再出现事件条绘制到非当月日期格。
2. 连续左右滑动切月，体验顺滑，无跳变闪烁。
3. 边界月按钮禁用与分页边界行为正确。
4. 热力图入口传入日期落月正确。
5. loading/empty/content/error 全路径都有自然动画。

## 11. 性能与扩展
- 现阶段：
  - 月数据缓存 + 相邻月预取。
- 后续扩展位：
  - 封面取色缓存（`bookId + coverURL hash`）。
  - 年月快速跳转器。
  - 事件条点击回调（日详情/书籍详情）。
  - A/B：`crossWeekContinuous` 与 `androidCompatible` 模式切换。

## 12. 风险与回滚
- 风险：
  - 分页重构带来的状态同步复杂度。
- 缓解：
  - 以 `pagerSelection` 单一入口收敛切月路径。
  - 使用 request ticket 避免旧请求污染状态。
- 回滚策略：
  - 保留 ViewModel 的按月状态模型与布局纯函数；
  - 仅替换 View 层分页容器即可回退交互实现。
