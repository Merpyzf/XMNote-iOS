# 富文本编辑器 — 需求文档

## 功能背景

纸间书摘 Android 端使用自研的 Knife 富文本编辑器（基于 `EditText` + `Spannable`），支持 8 种格式，数据以 HTML 字符串持久化于 SQLite `note` 表的 `content` 字段。

iOS 端需要实现功能对等的富文本编辑器，核心约束：

1. 支持与 Android 端完全相同的 8 种格式
2. HTML 序列化格式必须双向兼容——iOS 写入的 HTML，Android 能正确渲染；反之亦然
3. 高亮色在两端视觉一致，dark mode 下自动适配

---

## 格式定义

| 格式 | 级别 | HTML 标签 | Android 对应 Span |
|------|------|-----------|-------------------|
| 粗体 | 字符级 | `<b>` | `StyleSpan(Typeface.BOLD)` |
| 斜体 | 字符级 | `<i>` | `StyleSpan(Typeface.ITALIC)` |
| 下划线 | 字符级 | `<u>` | `UnderlineSpan` |
| 删除线 | 字符级 | `<del>` | `StrikethroughSpan` |
| 高亮 | 字符级 | `<mark style="background-color:{int32}">` | `KnifeHighlightSpan` |
| 无序列表 | 段落级 | `<ul><li>...</li></ul>` | `KnifeBulletSpan` |
| 引用块 | 段落级 | `<blockquote>` | `KnifeQuoteSpan` |
| 链接 | 字符级 | `<a href="...">` | `URLSpan` |

---

## 跨平台数据兼容性

### HTML 格式规范

- 换行使用 `<br>` 标签
- Android Knife 在 HTML 头部插入的 `&zwj;`（零宽连接符）需在解析时清除
- 连续空格序列化为 `&nbsp;` + 尾部保留空格（与 Android `Html.toHtml` 行为一致）
- Unicode 代理对序列化为 `&#codepoint;` 数字实体
- `<strong>` / `<em>` / `<s>` / `<strike>` 作为 `<b>` / `<i>` / `<del>` 的别名，解析时等价处理

### 高亮色存储格式

- HTML 中高亮色以 Android 有符号 Int32 格式存储：`background-color:-394337`
- 该值是 ARGB UInt32 的 `Int32(bitPattern:)` 表示
- 存储的始终是 light mode 色值，dark mode 仅影响显示，不影响持久化
- 13 组预定义高亮色，每组包含 light / dark 对应值

---

## 附加功能

| 功能 | 说明 |
|------|------|
| 撤销 / 重做 | 依赖系统 `UndoManager`，工具栏实时反映可用状态 |
| 清除格式 | 移除选区内所有格式属性，保留纯文本 |
| 收起键盘 | 工具栏右侧按钮，调用 `resignFirstResponder` |

---

## 不在范围内

- 图片插入与展示
- 有序列表（`<ol>`）
- 标题层级（`<h1>` ~ `<h6>`）
- 字体大小 / 字体族切换
- 文字颜色（前景色）
- 表格
- 代码块
- 实时协同编辑

这些功能 Android 端同样不支持，不属于迁移范围。
